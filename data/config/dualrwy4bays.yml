# VatEFS Configuration for dual runway, 4 bays (e.g. ESSA)
# Separate sections for arrival runway and departure runway.
# The departure runway section is the "exception" — flights on a third runway
# or with no matching active runway default to the arrival runway section.
# Section titles use templates: <arwy> and <drwy> resolve to active runway identifiers.

name: 2RWY4BAY
radarRange: 25  # nm

layout:
  bays:
    bay1:
      sections:
        inbound:
          title: INBOUND
        ctr_arr:
          title: CTR ARR
        arr_runway:
          title: RUNWAY <arwy>

    bay2:
      sections:
        ctr_dep:
          title: CTR DEP
        dep_runway:
          title: RUNWAY <drwy>

    bay3:
      sections:
        taxi:
          title: TAXI
        push_start:
          title: PUSH&START

    bay4:
      sections:
        pending_dep:
          title: PENDING DEP
        cleared:
          title: CLEARED

sectionRules:
  # === GEOGRAPHIC RUNWAY DETECTION (highest priority) ===

  # Aircraft physically on the departure runway
  on_runway_geographic_dep:
    sectionId: dep_runway
    onRunway: true
    depRunway: true
    priority: 201

  # Aircraft physically on the arrival runway (or any other runway — fallback)
  on_runway_geographic_arr:
    sectionId: arr_runway
    onRunway: true
    priority: 200

  # === DEPARTURE FLOW ===

  # PENDING DEP: Departures without clearance (no groundstate or ONFREQ)
  pending_dep:
    sectionId: pending_dep
    direction: departure
    airborne: false
    groundstates: ['', NSTS, ONFREQ]
    clearance: false
    priority: 40

  # CLEARED: Departures with clearance flag
  cleared:
    sectionId: cleared
    direction: departure
    airborne: false
    clearance: true
    groundstates: ['', NSTS, ONFREQ]  # Not yet pushing
    priority: 50

  # PUSH&START: Departures with DE-ICE (=READY) or STUP or PUSH
  push_start:
    sectionId: push_start
    direction: departure
    airborne: false
    groundstates: [DE-ICE, STUP, PUSH]
    priority: 60

  # TAXI: Departures taxiing (after pushback, before lineup)
  taxi_dep:
    sectionId: taxi
    direction: departure
    airborne: false
    groundstates: [TAXI, TXIN]
    priority: 30

  # DEP RUNWAY: Lineup and departure roll on departure runway
  runway_lineup_depa_dep:
    sectionId: dep_runway
    airborne: false
    groundstates: [LINEUP, DEPA]
    depRunway: true
    priority: 91

  # ARR RUNWAY: Lineup and departure roll on arrival/other runway (exception)
  runway_lineup_depa_arr:
    sectionId: arr_runway
    airborne: false
    groundstates: [LINEUP, DEPA]
    depRunway: false
    priority: 90

  # CTR DEP: Missed approach — airborne arrival controlled by me (highest priority)
  ctr_dep_missed_approach:
    sectionId: ctr_dep
    missedApproach: true
    controller: myself
    airborne: true
    priority: 105

  # CTR DEP: Airborne departures
  ctr_dep_airborne:
    sectionId: ctr_dep
    direction: departure
    airborne: true
    priority: 100

  # === LOCAL FLIGHT GROUND FLOW (mirrors departure flow) ===

  # PENDING DEP: Local flights without clearance
  pending_dep_local:
    sectionId: pending_dep
    direction: local
    airborne: false
    groundstates: ['', NSTS, ONFREQ]
    clearance: false
    priority: 40

  # CLEARED: Local flights with clearance flag
  cleared_local:
    sectionId: cleared
    direction: local
    airborne: false
    clearance: true
    groundstates: ['', NSTS, ONFREQ]
    priority: 50

  # PUSH&START: Local flights with DE-ICE/STUP/PUSH
  push_start_local:
    sectionId: push_start
    direction: local
    airborne: false
    groundstates: [DE-ICE, STUP, PUSH]
    priority: 60

  # TAXI: Local flights taxiing out (pre-departure phase)
  taxi_dep_local:
    sectionId: taxi
    direction: local
    airborne: false
    groundstates: [TAXI]
    priority: 30

  # TAXI: Local flights after landing (post-arrival phase)
  taxi_arr_local:
    sectionId: taxi
    direction: local
    airborne: false
    groundstates: [ARR, TXIN]
    priority: 35

  # CTR DEP: Airborne local flights (user can manually drag to CTR ARR)
  ctr_dep_airborne_local:
    sectionId: ctr_dep
    direction: local
    airborne: true
    priority: 100

  # === ARRIVAL FLOW ===

  # INBOUND: Arrivals not yet assumed (ARR groundstate or just arriving)
  inbound_arr_groundstate:
    sectionId: inbound
    direction: arrival
    airborne: true
    groundstates: ['', NSTS, ARR]
    controller: not_myself
    priority: 70

  # CTR ARR: Arrivals assumed by me
  ctr_arr_assumed:
    sectionId: ctr_arr
    direction: arrival
    controller: myself
    airborne: true
    groundstates: ['', NSTS, ARR]
    priority: 80

  # CTR ARR: Arrivals inside CTR boundary (real LFV data)
  ctr_arr_within_ctr:
    sectionId: ctr_arr
    direction: arrival
    airborne: true
    groundstates: ['', NSTS, ARR]
    withinCtr: true
    priority: 76

  # CTR ARR: Fallback - arrivals below 1500ft AGL (when CTR data unavailable)
  ctr_arr_low_altitude:
    sectionId: ctr_arr
    direction: arrival
    airborne: true
    groundstates: ['', NSTS, ARR]
    maxAltitudeAboveField: 1500
    priority: 75

  # DEP RUNWAY: Cleared to land on departure runway (exception)
  runway_cleared_to_land_dep:
    sectionId: dep_runway
    direction: either
    clearedToLand: true
    airborne: true
    groundstates: ['', NSTS, ARR]
    depRunway: true
    priority: 96

  # ARR RUNWAY: Cleared to land on arrival/other runway (normal case)
  runway_cleared_to_land_arr:
    sectionId: arr_runway
    direction: either
    clearedToLand: true
    airborne: true
    groundstates: ['', NSTS, ARR]
    priority: 95

  # TAXI: Arrivals taxiing in (after vacating runway)
  taxi_arr:
    sectionId: taxi
    direction: arrival
    airborne: false
    groundstates: ['', NSTS, ARR, TAXI, TXIN]
    priority: 30

  # === FALLBACKS ===

  # Catch-all for arrivals at our airport
  fallback_arrival:
    sectionId: inbound
    direction: arrival
    airborne: true
    priority: 5

  # Catch-all for departures at our airport
  fallback_departure:
    sectionId: pending_dep
    direction: departure
    priority: 5

  # Catch-all for local flights
  fallback_local:
    sectionId: pending_dep
    direction: local
    priority: 5

actionRules:
  # === ROLE-SPECIFIC RULES (high priority overrides) ===

  # DEL: READY for cleared departures/local (sets DE-ICE + transfer, instead of PUSH)
  ready_del:
    action: READY
    direction: either
    controller: myself
    clearance: true
    groundstates: ['', ONFREQ, STUP, NSTS]
    myRole: [DEL]
    priority: 120

  # DEL: CLNC always available for pending departures/local
  clnc_del:
    action: CLNC
    sectionId: pending_dep
    direction: either
    clearance: false
    myRole: [DEL]
    priority: 115

  # DEL: ASSUME ground departures/local
  assume_dep_del:
    action: ASSUME
    direction: either
    controller: not_myself
    airborne: false
    myRole: [DEL]
    priority: 110

  # GND: XFER to TWR for taxi departures/local
  xfer_gnd_taxi_dep:
    action: XFER
    direction: either
    controller: myself
    groundstates: [TAXI]
    myRole: [GND]
    priority: 115

  # GND/TWR/APP/CTR: PUSH for DE-ICE departures/local (after assuming from DEL)
  push_deice_gnd:
    action: PUSH
    sectionId: push_start
    direction: either
    controller: myself
    groundstates: [DE-ICE]
    myRole: [GND, TWR, APP, CTR]
    priority: 113

  # GND: TXI for on-ground arrivals/local (after landing)
  txi_arr_gnd:
    action: TXI
    direction: either
    controller: myself
    groundstates: ['', NSTS, ARR]
    airborne: false
    myRole: [GND]
    priority: 112

  # GND: ASSUME on-ground arrivals (handoff from TWR)
  assume_arr_gnd:
    action: ASSUME
    direction: arrival
    controller: not_myself
    airborne: false
    myRole: [GND]
    priority: 111

  # TWR/APP/CTR: XFER to GND for on-ground arrivals/local when GND is separately online
  xfer_twr_to_gnd:
    action: XFER
    direction: either
    controller: myself
    groundstates: ['', NSTS, ARR]
    airborne: false
    myRole: [TWR, APP, CTR]
    notMyRole: [GND]
    priority: 110

  # === EXISTING RULES (with role conditions where needed) ===

  # INBOUND arrivals: ASSUME to take control (TWR/APP/CTR top-down)
  assume_inbound:
    action: ASSUME
    sectionId: inbound
    direction: arrival
    controller: not_myself
    myRole: [TWR, APP, CTR]
    priority: 100

  # CTR ARR: CTL (cleared to land) for arrivals and local flights (TWR/APP/CTR top-down)
  ctl_ctr_arr:
    action: CTL
    sectionId: ctr_arr
    direction: either
    controller: myself
    clearedToLand: false
    myRole: [TWR, APP, CTR]
    priority: 90

  # RUNWAY lineup: CTO (cleared for takeoff) (TWR/APP/CTR top-down)
  # No sectionId — works for both arr_runway and dep_runway
  cto_lineup:
    action: CTO
    direction: either
    controller: myself
    groundstates: [LINEUP]
    myRole: [TWR, APP, CTR]
    priority: 90

  # ARR RUNWAY: GOA (go-around) for airborne aircraft cleared to land (TWR/APP/CTR top-down)
  goa_arr_runway:
    action: GOA
    sectionId: arr_runway
    direction: either
    controller: myself
    airborne: true
    clearedToLand: true
    myRole: [TWR, APP, CTR]
    priority: 95

  # DEP RUNWAY: GOA (go-around) for airborne aircraft cleared to land (TWR/APP/CTR top-down)
  goa_dep_runway:
    action: GOA
    sectionId: dep_runway
    direction: either
    controller: myself
    airborne: true
    clearedToLand: true
    myRole: [TWR, APP, CTR]
    priority: 95

  # CTR DEP missed approach: XFER to APP when APP is separately online (TWR top-down)
  xfer_missed_approach:
    action: XFER
    missedApproach: true
    controller: myself
    handoffInitiated: false
    myRole: [TWR, APP, CTR]
    notMyRole: [APP]
    priority: 102

  # CTR DEP airborne: XFER (transfer to next controller) (TWR/APP/CTR top-down)
  # Departures only — local flights stay in the pattern, no XFER
  xfer_ctr_dep:
    action: XFER
    sectionId: ctr_dep
    direction: departure
    controller: myself
    airborne: true
    handoffInitiated: false
    myRole: [TWR, APP, CTR]
    priority: 80

  # Taxiing arrivals/local: PARK (set parked) (GND/TWR/APP/CTR)
  park_arr:
    action: PARK
    direction: either
    controller: myself
    groundstates: [TXIN]
    onRunway: false
    myRole: [GND, TWR, APP, CTR]
    priority: 77

  # PUSH&START departures/local with PUSH groundstate: TXO (taxi out) (GND/TWR/APP/CTR)
  txo_push:
    action: TXO
    sectionId: push_start
    direction: either
    controller: myself
    groundstates: [PUSH, STUP]
    myRole: [GND, TWR, APP, CTR]
    priority: 75

  # PENDING DEP departures/local without clearance: CLNC (open clearance dialog)
  # Only shown when DEL is not separately online (I'm covering DEL duties)
  clnc_pending_dep:
    action: CLNC
    sectionId: pending_dep
    direction: either
    clearance: false
    myRole: [DEL]
    priority: 65

  # CLEARED departures/local: PUSH (approve startup/pushback) (GND/TWR/APP/CTR)
  push_cleared:
    action: PUSH
    sectionId: cleared
    direction: either
    controller: myself
    clearance: true
    groundstates: ['', ONFREQ, STUP, NSTS]
    myRole: [GND, TWR, APP, CTR]
    priority: 70

  # === CATCH-ALL ASSUME RULES ===

  # Assume any departure/local tracked by someone else when I'm covering DEL duties
  assume_departure_ground:
    action: ASSUME
    direction: either
    controller: not_myself
    airborne: false
    myRole: [DEL]
    priority: 10

  # Assume any untracked arrival (GND/TWR/APP/CTR)
  assume_arrival:
    action: ASSUME
    direction: arrival
    controller: not_myself
    myRole: [GND, TWR, APP, CTR]
    priority: 10

deleteRules:
  # Departures: Delete when high enough and transferred/freed
  delete_dep_high_transferred:
    direction: departure
    controller: not_myself
    minAltitudeAboveField: 2500
    priority: 100

  # Arrivals/local: Delete when parked
  delete_parked:
    direction: either
    groundstates: [PARK]
    priority: 100

  # Fallback: Delete any aircraft that moves beyond radar range
  delete_beyond_range:
    beyondRange: true
    priority: 10

moveRules:
  # === DEPARTURE/LOCAL FLOW ===

  # PENDING DEP -> CLEARED: Set clearance flag (DEL/TWR/APP/CTR)
  move_pending_to_cleared:
    fromSectionId: pending_dep
    toSectionId: cleared
    direction: either
    myRole: [DEL, TWR, APP, CTR]
    command:
      type: setClearance
      value: true

  # CLEARED -> PUSH&START: Set groundstate to PUSH (GND/TWR/APP/CTR)
  move_cleared_to_push:
    fromSectionId: cleared
    toSectionId: push_start
    direction: either
    myRole: [GND, TWR, APP, CTR]
    command:
      type: setGroundstate
      value: PUSH

  # PUSH&START -> TAXI: Set groundstate to TAXI (GND/TWR/APP/CTR)
  move_push_to_taxi:
    fromSectionId: push_start
    toSectionId: taxi
    direction: either
    myRole: [GND, TWR, APP, CTR]
    command:
      type: setGroundstate
      value: TAXI

  # TAXI -> DEP RUNWAY: Set groundstate to LINEUP (TWR/APP/CTR top-down)
  move_taxi_to_dep_runway:
    fromSectionId: taxi
    toSectionId: dep_runway
    direction: either
    myRole: [TWR, APP, CTR]
    command:
      type: setGroundstate
      value: LINEUP

  # TAXI -> ARR RUNWAY: Set groundstate to LINEUP (TWR/APP/CTR top-down, exception)
  move_taxi_to_arr_runway:
    fromSectionId: taxi
    toSectionId: arr_runway
    direction: either
    myRole: [TWR, APP, CTR]
    command:
      type: setGroundstate
      value: LINEUP

  # === ARRIVAL FLOW ===

  # INBOUND -> ARR RUNWAY: Set cleared to land (TWR/APP/CTR top-down)
  move_inbound_to_arr_runway:
    fromSectionId: inbound
    toSectionId: arr_runway
    direction: arrival
    myRole: [TWR, APP, CTR]
    command:
      type: setClearedToLand
      value: true

  # INBOUND -> DEP RUNWAY: Set cleared to land (TWR/APP/CTR top-down, exception)
  move_inbound_to_dep_runway:
    fromSectionId: inbound
    toSectionId: dep_runway
    direction: either
    myRole: [TWR, APP, CTR]
    command:
      type: setClearedToLand
      value: true

  # CTR ARR -> ARR RUNWAY: Set cleared to land (TWR/APP/CTR top-down)
  move_ctr_arr_to_arr_runway:
    fromSectionId: ctr_arr
    toSectionId: arr_runway
    direction: either
    myRole: [TWR, APP, CTR]
    command:
      type: setClearedToLand
      value: true

  # CTR ARR -> DEP RUNWAY: Set cleared to land (TWR/APP/CTR top-down, exception)
  move_ctr_arr_to_dep_runway:
    fromSectionId: ctr_arr
    toSectionId: dep_runway
    direction: either
    myRole: [TWR, APP, CTR]
    command:
      type: setClearedToLand
      value: true

  # ARR RUNWAY -> TAXI (departure): Set groundstate to TAXI
  move_arr_runway_to_taxi_dep:
    fromSectionId: arr_runway
    toSectionId: taxi
    direction: departure
    priority: 10
    command:
      type: setGroundstate
      value: TAXI

  # ARR RUNWAY -> TAXI (arrival/local): Set groundstate to TXIN (GND/TWR/APP/CTR)
  move_arr_runway_to_taxi:
    fromSectionId: arr_runway
    toSectionId: taxi
    direction: either
    myRole: [GND, TWR, APP, CTR]
    command:
      type: setGroundstate
      value: TXIN

  # DEP RUNWAY -> TAXI (departure): Set groundstate to TAXI
  move_dep_runway_to_taxi_dep:
    fromSectionId: dep_runway
    toSectionId: taxi
    direction: departure
    priority: 10
    command:
      type: setGroundstate
      value: TAXI

  # DEP RUNWAY -> TAXI (arrival/local): Set groundstate to TXIN (GND/TWR/APP/CTR)
  move_dep_runway_to_taxi:
    fromSectionId: dep_runway
    toSectionId: taxi
    direction: either
    myRole: [GND, TWR, APP, CTR]
    command:
      type: setGroundstate
      value: TXIN

  # === UNDO OPERATIONS ===

  # CLEARED -> PENDING DEP: Unset clearance flag
  undo_cleared_to_pending:
    fromSectionId: cleared
    toSectionId: pending_dep
    direction: either
    command:
      type: setClearance
      value: false

  # PUSH&START -> CLEARED: Set groundstate to ONFREQ
  undo_push_to_cleared:
    fromSectionId: push_start
    toSectionId: cleared
    direction: either
    command:
      type: setGroundstate
      value: ONFREQ

  # TAXI -> PUSH&START: Set groundstate to PUSH
  undo_taxi_to_push:
    fromSectionId: taxi
    toSectionId: push_start
    direction: either
    command:
      type: setGroundstate
      value: PUSH

  # ARR RUNWAY -> CTR ARR: Unset cleared to land
  undo_arr_runway_to_ctr_arr:
    fromSectionId: arr_runway
    toSectionId: ctr_arr
    direction: either
    command:
      type: setClearedToLand
      value: false

  # DEP RUNWAY -> CTR ARR: Unset cleared to land
  undo_dep_runway_to_ctr_arr:
    fromSectionId: dep_runway
    toSectionId: ctr_arr
    direction: either
    command:
      type: setClearedToLand
      value: false

  # ARR RUNWAY -> CTR DEP: Unset cleared to land (go-around)
  arr_runway_to_ctr_dep_go_around:
    fromSectionId: arr_runway
    toSectionId: ctr_dep
    direction: either
    command:
      type: setClearedToLand
      value: false

  # DEP RUNWAY -> CTR DEP: Unset cleared to land (go-around)
  dep_runway_to_ctr_dep_go_around:
    fromSectionId: dep_runway
    toSectionId: ctr_dep
    direction: either
    command:
      type: setClearedToLand
      value: false
