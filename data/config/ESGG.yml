# VatEFS Configuration for ESGG (Gothenburg)
# Note: Airports are discovered at runtime from EuroScope's rwyconfig
# or can be set via --airport CLI argument

radarRange: 25  # nm

layout:
  bays:
    bay1:
      sections:
        inbound:
          title: INBOUND

    bay2:
      sections:
        ctr_arr:
          title: CTR ARR
        runway:
          title: RUNWAY
        ctr_dep:
          title: CTR DEP

    bay3:
      sections:
        taxi:
          title: TAXI
        push_start:
          title: PUSH&START

    bay4:
      sections:
        pending_dep:
          title: PENDING DEP
        cleared:
          title: CLEARED

sectionRules:
  # === GEOGRAPHIC RUNWAY DETECTION (highest priority) ===

  # Any aircraft physically on a runway (detected by geographic position and altitude)
  # This overrides all other section rules
  on_runway_geographic:
    sectionId: runway
    onRunway: true
    priority: 200

  # === DEPARTURE FLOW ===

  # PENDING DEP: Departures without clearance (no groundstate or ONFREQ)
  pending_dep:
    sectionId: pending_dep
    direction: departure
    airborne: false
    groundstates: ['', NSTS, ONFREQ]
    clearance: false
    priority: 40

  # CLEARED: Departures with clearance flag
  cleared:
    sectionId: cleared
    direction: departure
    airborne: false
    clearance: true
    groundstates: ['', NSTS, ONFREQ]  # Not yet pushing
    priority: 50

  # PUSH&START: Departures with DE-ICE (=READY) or STUP or PUSH
  push_start:
    sectionId: push_start
    direction: departure
    airborne: false
    groundstates: [DE-ICE, STUP, PUSH]
    priority: 60

  # TAXI: Departures taxiing (after pushback, before lineup)
  taxi_dep:
    sectionId: taxi
    direction: departure
    airborne: false
    groundstates: [TAXI, TXIN]
    priority: 30

  # RUNWAY: Lineup and departure roll
  runway_lineup_depa:
    sectionId: runway
    groundstates: [LINEUP, DEPA]
    priority: 90

  # CTR DEP: Airborne departures (groundstate DEPA + airborne flag)
  ctr_dep_airborne:
    sectionId: ctr_dep
    direction: departure
    airborne: true
    priority: 100

  # === ARRIVAL FLOW ===

  # INBOUND: Arrivals not yet assumed (ARR groundstate or just arriving)
  inbound_arr_groundstate:
    sectionId: inbound
    direction: arrival
    airborne: true
    groundstates: ['', NSTS, ARR]
    controller: not_myself
    priority: 70

  # CTR ARR: Arrivals assumed by me
  ctr_arr_assumed:
    sectionId: ctr_arr
    direction: arrival
    controller: myself
    airborne: true
    groundstates: ['', NSTS, ARR]
    priority: 80

  # CTR ARR: Arrivals inside CTR boundary (real LFV data)
  ctr_arr_within_ctr:
    sectionId: ctr_arr
    direction: arrival
    airborne: true
    groundstates: ['', NSTS, ARR]
    withinCtr: true
    priority: 76

  # CTR ARR: Fallback - arrivals below 1500ft AGL (when CTR data unavailable)
  ctr_arr_low_altitude:
    sectionId: ctr_arr
    direction: arrival
    airborne: true
    groundstates: ['', NSTS, ARR]
    maxAltitudeAboveField: 1500
    priority: 75

  # RUNWAY: Cleared to land arrivals
  runway_cleared_to_land:
    sectionId: runway
    direction: arrival
    clearedToLand: true
    airborne: true
    groundstates: ['', NSTS, ARR]
    priority: 95

  # TAXI: Arrivals taxiing in (after vacating runway)
  taxi_arr:
    sectionId: taxi
    direction: arrival
    airborne: false
    groundstates: ['', NSTS, ARR, TAXI, TXIN]
    priority: 30

  # === FALLBACKS ===

  # Catch-all for arrivals at our airport
  fallback_arrival:
    sectionId: inbound
    direction: arrival
    airborne: true
    priority: 5

  # Catch-all for departures at our airport
  fallback_departure:
    sectionId: pending_dep
    direction: departure
    priority: 5

actionRules:
  # INBOUND arrivals: ASSUME to take control
  assume_inbound:
    action: ASSUME
    sectionId: inbound
    direction: arrival
    controller: not_myself
    priority: 100

  # CTR ARR arrivals: CTL (cleared to land)
  ctl_ctr_arr:
    action: CTL
    sectionId: ctr_arr
    direction: arrival
    controller: myself
    clearedToLand: false  # Only if not already cleared
    priority: 90

  # RUNWAY lineup: CTO (cleared for takeoff)
  cto_lineup:
    action: CTO
    sectionId: runway
    direction: departure
    controller: myself
    groundstates: [LINEUP]
    priority: 90

  # CTR DEP airborne: XFER (transfer to next controller)
  xfer_ctr_dep:
    action: XFER
    sectionId: ctr_dep
    direction: departure
    controller: myself
    airborne: true
    handoffInitiated: false
    priority: 80

  # Taxiing arrivals: PARK (set parked)
  park_arr:
    action: PARK
    direction: arrival
    controller: myself
    groundstates: [TXIN]
    priority: 77

  # Arrivals on ground (not airborne, not on runway): TXI (taxi in)
  txi_arr:
    action: TXI
    direction: arrival
    controller: myself
    groundstates: ['', NSTS, ARR]
    clearedToLand: false
    airborne: false
    priority: 76

  # PUSH&START departures with PUSH groundstate: TXO (taxi out)
  txo_push:
    action: TXO
    sectionId: push_start
    direction: departure
    controller: myself
    groundstates: [PUSH]
    priority: 75

  # PENDING DEP departures without clearance: CLNC (open clearance dialog)
  clnc_pending_dep:
    action: CLNC
    sectionId: pending_dep
    direction: departure
    clearance: false
    priority: 65

  # CLEARED departures: PUSH (approve startup/pushback)
  push_cleared:
    action: PUSH
    sectionId: cleared
    direction: departure
    controller: myself
    clearance: true
    groundstates: ['', ONFREQ, STUP, NSTS]
    priority: 70

  # === CATCH-ALL ASSUME RULES ===

  # Assume any untracked departure on the ground
  assume_departure_ground:
    action: ASSUME
    direction: departure
    controller: not_myself
    airborne: false
    priority: 10

  # Assume any untracked arrival
  assume_arrival:
    action: ASSUME
    direction: arrival
    controller: not_myself
    priority: 10

deleteRules:
  # Departures: Delete when high enough and transferred/freed
  # Altitude > field elevation + 1500ft AND not controlled by me
  delete_dep_high_transferred:
    direction: departure
    controller: not_myself
    minAltitudeAboveField: 2500
    priority: 100

  # Arrivals: Delete when parked
  delete_arr_parked:
    direction: arrival
    groundstates: [PARK]
    priority: 100

  # Fallback: Delete any aircraft that moves beyond radar range
  # This catches cases where other rules didn't trigger
  delete_beyond_range:
    beyondRange: true
    priority: 10

moveRules:
  # === DEPARTURE FLOW ===

  # PENDING DEP -> CLEARED: Set clearance flag
  move_pending_to_cleared:
    fromSectionId: pending_dep
    toSectionId: cleared
    direction: departure
    command:
      type: setClearance
      value: true

  # CLEARED -> PUSH&START: Set groundstate to PUSH
  move_cleared_to_push:
    fromSectionId: cleared
    toSectionId: push_start
    direction: departure
    command:
      type: setGroundstate
      value: PUSH

  # PUSH&START -> TAXI: Set groundstate to TAXI
  move_push_to_taxi:
    fromSectionId: push_start
    toSectionId: taxi
    direction: departure
    command:
      type: setGroundstate
      value: TAXI

  # TAXI -> RUNWAY: Set groundstate to LINEUP
  move_taxi_to_runway:
    fromSectionId: taxi
    toSectionId: runway
    direction: departure
    command:
      type: setGroundstate
      value: LINEUP

  # === ARRIVAL FLOW ===

  # INBOUND -> RUNWAY: Set cleared to land
  move_inbound_to_runway:
    fromSectionId: inbound
    toSectionId: runway
    direction: arrival
    command:
      type: setClearedToLand
      value: true

  # CTR ARR -> RUNWAY: Set cleared to land
  move_ctr_arr_to_runway:
    fromSectionId: ctr_arr
    toSectionId: runway
    direction: arrival
    command:
      type: setClearedToLand
      value: true

  # RUNWAY -> TAXI (arrival): Set groundstate to TXIN
  move_runway_to_taxi_arr:
    fromSectionId: runway
    toSectionId: taxi
    direction: arrival
    command:
      type: setGroundstate
      value: TXIN
